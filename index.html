<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í˜„ì¥ ì¸¡ì • ì‹œìŠ¤í…œ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f1f3f5; padding-bottom: 30px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .container { max-width: 600px; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .form-label { font-weight: 600; font-size: 0.9rem; color: #495057; }
        .history-card { border-left: 5px solid #0d6efd; transition: transform 0.2s; }
        .history-card:active { transform: scale(0.98); }
        .loading-spinner { display: none; }
        #editBadge { display: none; }
    </style>
</head>
<body>

<div class="container py-4">
    <div class="card p-4 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">ğŸ“ ì¸¡ì • ë°ì´í„° ì…ë ¥</h5>
            <span id="editBadge" class="badge bg-warning text-dark">ìˆ˜ì • ëª¨ë“œ</span>
        </div>
        
        <form id="measureForm">
            <input type="hidden" id="rowId">
            
            <div class="row g-2 mb-3">
                <div class="col-6">
                    <label class="form-label">í˜„ì¥ëª…</label>
                    <input type="text" id="í˜„ì¥" class="form-control" placeholder="í˜„ì¥ ì´ë¦„" required>
                </div>
                <div class="col-6">
                    <label class="form-label">êµ¬ì—­</label>
                    <input type="text" id="êµ¬ì—­" class="form-control" placeholder="êµ¬ì—­/ì¸µ">
                </div>
            </div>

            <div class="row g-2 mb-3">
                <div class="col-6">
                    <label class="form-label">ë„ë©´ë²ˆí˜¸</label>
                    <input type="text" id="ë„ë©´ë²ˆí˜¸" class="form-control" placeholder="ë„ë©´ ë²ˆí˜¸">
                </div>
                <div class="col-6">
                    <label class="form-label">í•­ëª©</label>
                    <input type="text" id="í•­ëª©" class="form-control" placeholder="ë³´, ê¸°ë‘¥ ë“±">
                </div>
            </div>

            <label class="form-label">ì¸¡ì •ê°’ (ìµœì†Œ í•˜ë‚˜ ì…ë ¥)</label>
            <div class="row g-2 mb-3">
                <div class="col-4"><input type="number" id="x" class="form-control" placeholder="X(mm)"></div>
                <div class="col-4"><input type="number" id="y" class="form-control" placeholder="Y(mm)"></div>
                <div class="col-4"><input type="number" id="z" class="form-control" placeholder="Z(mm)"></div>
            </div>

            <div class="mb-3">
                <label class="form-label">ë©”ëª¨</label>
                <textarea id="ë©”ëª¨" class="form-control" rows="2" placeholder="ì°¸ê³ ì‚¬í•­"></textarea>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" id="submitBtn" class="btn btn-primary w-100 py-3 font-weight-bold">ë°ì´í„° ì €ì¥</button>
                <button type="button" id="cancelBtn" class="btn btn-light" style="display:none;" onclick="resetForm()">ì·¨ì†Œ</button>
            </div>
        </form>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">ìµœê·¼ ì…ë ¥ ë‚´ì—­</h5>
        <button class="btn btn-sm btn-outline-secondary" onclick="loadData()">ìƒˆë¡œê³ ì¹¨</button>
    </div>

    <div id="historyList">
        <div class="text-center py-5">
            <div class="spinner-border text-primary loading-spinner" id="loader" role="status"></div>
            <p id="statusMsg">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
    </div>
</div>

<script>
    // 1. ìì‹ ì˜ Google Apps Script URLë¡œ ë³€ê²½í•˜ì„¸ìš”.
    const API_URL = 'https://script.google.com/macros/s/AKfycbzKNheqQ2GD-io-EfS-qzw-B616pqtdECC_KBBTPeOVBBZwN4kfZfpEW1tOqUiYShHWrg/exec';
    
    // 2. ê¸°ê¸° ê³ ìœ  ID ìƒì„± (localStorage ì €ì¥)
    let deviceId = localStorage.getItem('field_device_id');
    if (!deviceId) {
        deviceId = 'DEV-' + Math.random().toString(36).substr(2, 9).toUpperCase();
        localStorage.setItem('field_device_id', deviceId);
    }

    // ì „ì—­ ë°ì´í„° ë³´ê´€ìš© (ìˆ˜ì • ì‹œ ì°¸ì¡°)
    let fetchedData = [];

    // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (Read)
    async function loadData() {
        const loader = document.getElementById('loader');
        const statusMsg = document.getElementById('statusMsg');
        const container = document.getElementById('historyList');
        
        loader.style.display = 'inline-block';
        statusMsg.innerText = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

        try {
            const response = await fetch(API_URL);
            const data = await response.json();
            fetchedData = data; // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥

            container.innerHTML = '';
            if (data.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-4">ê¸°ë¡ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            } else {
                data.forEach((item, index) => {
                    const card = document.createElement('div');
                    card.className = 'card p-3 mb-2 history-card';
                    card.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start">
                            <div onclick="fillFormForEdit(${index})" style="cursor:pointer; flex-grow:1;">
                                <div class="fw-bold text-primary">${item['í•­ëª©'] || 'ë¯¸ì§€ì • í•­ëª©'}</div>
                                <div class="text-dark my-1">
                                    <span class="badge bg-light text-dark border">${item['x'] || 0}</span> x 
                                    <span class="badge bg-light text-dark border">${item['y'] || 0}</span> x 
                                    <span class="badge bg-light text-dark border">${item['z'] || 0}</span> (mm)
                                </div>
                                <div style="font-size: 0.8rem; color: #6c757d;">
                                    ${item['í˜„ì¥']} | ${item['êµ¬ì—­']} | ${item['ë„ë©´ë²ˆí˜¸'] || '-'}
                                </div>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" onclick="fillFormForEdit(${index})">ìˆ˜ì •</button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }
        } catch (error) {
            console.error('Fetch Error:', error);
            statusMsg.innerText = "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. URLì„ í™•ì¸í•˜ì„¸ìš”.";
        } finally {
            loader.style.display = 'none';
            if(container.innerHTML === '') statusMsg.innerText = "";
            else statusMsg.style.display = 'none';
        }
    }

    // ìˆ˜ì • í´ë¦­ ì‹œ í¼ì— ë°ì´í„° ì±„ìš°ê¸°
    function fillFormForEdit(index) {
        const item = fetchedData[index];
        document.getElementById('rowId').value = item.rowId;
        document.getElementById('í˜„ì¥').value = item['í˜„ì¥'];
        document.getElementById('êµ¬ì—­').value = item['êµ¬ì—­'];
        document.getElementById('ë„ë©´ë²ˆí˜¸').value = item['ë„ë©´ë²ˆí˜¸'];
        document.getElementById('í•­ëª©').value = item['í•­ëª©'];
        document.getElementById('x').value = item['x'];
        document.getElementById('y').value = item['y'];
        document.getElementById('z').value = item['z'];
        document.getElementById('ë©”ëª¨').value = item['ë©”ëª¨'];
        
        document.getElementById('editBadge').style.display = 'block';
        document.getElementById('cancelBtn').style.display = 'block';
        document.getElementById('submitBtn').innerText = "ë‚´ìš© ìˆ˜ì •í•˜ê¸°";
        document.getElementById('submitBtn').className = "btn btn-warning w-100 py-3";
        window.scrollTo(0, 0);
    }

    // í¼ ì´ˆê¸°í™”
    function resetForm() {
        document.getElementById('measureForm').reset();
        document.getElementById('rowId').value = '';
        document.getElementById('editBadge').style.display = 'none';
        document.getElementById('cancelBtn').style.display = 'none';
        document.getElementById('submitBtn').innerText = "ë°ì´í„° ì €ì¥";
        document.getElementById('submitBtn').className = "btn btn-primary w-100 py-3";
    }

    // ë°ì´í„° ì €ì¥ (Create / Update)
    document.getElementById('measureForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const rowId = document.getElementById('rowId').value;
        const data = {
            rowId: rowId,
            í˜„ì¥: document.getElementById('í˜„ì¥').value,
            êµ¬ì—­: document.getElementById('êµ¬ì—­').value,
            ë„ë©´ë²ˆí˜¸: document.getElementById('ë„ë©´ë²ˆí˜¸').value,
            í•­ëª©: document.getElementById('í•­ëª©').value,
            x: document.getElementById('x').value,
            y: document.getElementById('y').value,
            z: document.getElementById('z').value,
            ë‹¨ìœ„: 'mm',
            ë©”ëª¨: document.getElementById('ë©”ëª¨').value,
            deviceId: deviceId
        };

        if (!data.x && !data.y && !data.z) {
            alert("X, Y, Z ê¸¸ì´ ì¤‘ ìµœì†Œ í•˜ë‚˜ëŠ” ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
            return;
        }

        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.innerText = "ì²˜ë¦¬ ì¤‘...";

        try {
            await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify(data)
            });
            alert(rowId ? "ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!" : "ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
            resetForm();
            loadData();
        } catch (error) {
            alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            submitBtn.disabled = false;
        }
    });

    // ì•± ì‹œì‘ ì‹œ ë°ì´í„° ë¡œë“œ
    window.onload = loadData;
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
