<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>현장 측정 입력</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff" />
  <style>
    body{font-family:system-ui, sans-serif; margin:0; padding:16px; background:#f6f7f9;}
    .card{background:#fff; border-radius:16px; padding:16px; box-shadow:0 2px 10px rgba(0,0,0,.06); margin-bottom:12px;}
    label{display:block; font-size:13px; color:#555; margin-top:10px;}
    input, select, textarea, button{width:100%; font-size:18px; padding:12px; border-radius:12px; border:1px solid #ddd; box-sizing:border-box;}
    textarea{font-size:16px;}
    .row{display:flex; gap:10px;}
    .row > *{flex:1;}
    button{border:none; background:#111827; color:#fff; font-weight:700;}
    button.secondary{background:#e5e7eb; color:#111827;}
    .hint{font-size:13px; color:#6b7280; margin-top:8px;}
    .toast{position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background:#111827; color:#fff; padding:10px 14px; border-radius:999px; opacity:0; transition:.2s;}
    .toast.show{opacity:1;}
    .badge{display:inline-block; padding:6px 10px; border-radius:999px; background:#eef2ff; color:#3730a3; font-weight:700; font-size:13px;}
  </style>
</head>
<body>

<div class="card" id="pinCard">
  <div class="badge">PIN 1회 저장</div>
  <label>PIN (4자리)</label>
  <input id="pinInput" inputmode="numeric" maxlength="4" placeholder="예: 1234">
  <div class="row" style="margin-top:12px;">
    <button id="savePinBtn">PIN 저장</button>
    <button class="secondary" id="resetPinBtn" type="button">초기화</button>
  </div>
  <div class="hint">PIN은 기기(브라우저)에 저장됩니다.</div>
</div>

<div class="card" id="formCard" style="display:none;">
  <div class="row">
    <div>
      <label>현장/프로젝트</label>
      <input id="site" placeholder="예: 2도크" />
    </div>
    <div>
      <label>구역/블록</label>
      <input id="area" placeholder="예: A-12" />
    </div>
  </div>

  <div class="row">
    <div>
      <label>도면번호</label>
      <input id="drawing" placeholder="예: DWG-001" />
    </div>
    <div>
      <label>항목</label>
      <input id="item" placeholder="예: 케이블 길이" />
    </div>
  </div>

  <label>측정값</label>
  <div class="row">
    <input id="value" inputmode="decimal" placeholder="숫자만 입력" />
    <select id="unit">
      <option value="mm" selected>mm</option>
      <option value="m">m</option>
    </select>
  </div>
  <div class="hint">저장 시 mm로 자동 환산되어 기록됩니다.</div>

  <label>메모(옵션)</label>
  <textarea id="memo" rows="2" placeholder="필요 시만"></textarea>

  <div class="row" style="margin-top:12px;">
    <button id="saveBtn">저장</button>
    <button class="secondary" id="saveNextBtn" type="button">저장 + 다음</button>
  </div>

  <div class="row" style="margin-top:12px;">
    <button class="secondary" id="flushBtn" type="button">재전송(오프라인 저장분)</button>
    <button class="secondary" id="changePinBtn" type="button">PIN 변경</button>
  </div>

  <div class="hint" id="queueHint"></div>
</div>

<div class="toast" id="toast"></div>

<script>
  // ====== 설정 ======
  const API_URL = "PASTE_YOUR_APPS_SCRIPT_WEBAPP_URL_HERE"; // <-- 여기 교체
  const LS_PIN = "measure_pin_v1";
  const LS_QUEUE = "measure_queue_v1";
  const LS_DEVICE = "measure_device_v1";

  // ====== 유틸 ======
  const $ = (id)=>document.getElementById(id);
  const toast = (msg)=>{
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1400);
  };

  function getDeviceId(){
    let id = localStorage.getItem(LS_DEVICE);
    if(!id){
      id = "dev_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
      localStorage.setItem(LS_DEVICE, id);
    }
    return id;
  }

  function loadQueue(){
    try { return JSON.parse(localStorage.getItem(LS_QUEUE) || "[]"); }
    catch { return []; }
  }
  function saveQueue(q){
    localStorage.setItem(LS_QUEUE, JSON.stringify(q));
    $("queueHint").textContent = q.length ? `오프라인 저장분: ${q.length}건` : "";
  }

  function normalizeToMm(value, unit){
    const v = Number(value);
    if(!Number.isFinite(v) || v <= 0) return null;
    if(unit === "m") return Math.round(v * 1000); // m -> mm
    return Math.round(v); // mm
  }

  async function postRecord(record){
    const res = await fetch(API_URL, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(record)
    });
    return await res.json();
  }

  async function flushQueue(){
    const q = loadQueue();
    if(!q.length){ toast("대기 건 없음"); return; }

    let remain = [];
    for(const rec of q){
      try{
        const r = await postRecord(rec);
        if(!r.ok) remain.push(rec);
      }catch{
        remain.push(rec);
      }
    }
    saveQueue(remain);
    toast(remain.length ? `재전송 후 잔여 ${remain.length}건` : "전부 전송 완료");
  }

  // ====== PIN 흐름 ======
  function showFormIfPinned(){
    const pin = localStorage.getItem(LS_PIN);
    if(pin && pin.length === 4){
      $("pinCard").style.display = "none";
      $("formCard").style.display = "block";
      $("value").focus();
      saveQueue(loadQueue()); // 힌트 갱신
    }else{
      $("pinCard").style.display = "block";
      $("formCard").style.display = "none";
      $("pinInput").focus();
    }
  }

  $("savePinBtn").onclick = ()=>{
    const p = $("pinInput").value.trim();
    if(!/^\d{4}$/.test(p)){ toast("PIN 4자리"); return; }
    localStorage.setItem(LS_PIN, p);
    toast("PIN 저장됨");
    showFormIfPinned();
  };

  $("resetPinBtn").onclick = ()=>{
    localStorage.removeItem(LS_PIN);
    $("pinInput").value = "";
    toast("초기화");
    showFormIfPinned();
  };

  $("changePinBtn").onclick = ()=>{
    localStorage.removeItem(LS_PIN);
    toast("PIN 다시 설정");
    showFormIfPinned();
  };

  // ====== 저장 ======
  async function saveOnce(clearAfter){
    const pin = localStorage.getItem(LS_PIN);
    if(!pin){ toast("PIN 필요"); showFormIfPinned(); return; }

    const unit = $("unit").value;
    const mm = normalizeToMm($("value").value, unit);
    if(mm === null){ toast("측정값 확인"); $("value").focus(); return; }

    // 범위 예시(필요 시 조정)
    if(mm > 500000){ toast("값이 너무 큼"); return; }

    const record = {
      pin,
      site: $("site").value.trim(),
      area: $("area").value.trim(),
      drawing: $("drawing").value.trim(),
      item: $("item").value.trim(),
      value_mm: mm,
      unit,
      memo: $("memo").value.trim(),
      device_id: getDeviceId()
    };

    try{
      const r = await postRecord(record);
      if(r.ok){
        toast("저장됨");
      }else{
        // 서버 응답이 ok=false면 오프라인 큐에 적재
        const q = loadQueue();
        q.push(record);
        saveQueue(q);
        toast("전송 실패 → 임시저장");
      }
    }catch{
      const q = loadQueue();
      q.push(record);
      saveQueue(q);
      toast("오프라인 → 임시저장");
    }

    if(clearAfter){
      $("value").value = "";
      $("memo").value = "";
      $("value").focus();
    }
  }

  $("saveBtn").onclick = ()=>saveOnce(false);
  $("saveNextBtn").onclick = ()=>saveOnce(true);
  $("flushBtn").onclick = flushQueue;

  // 네트워크 복구 시 자동 재전송
  window.addEventListener("online", ()=>flushQueue());

  // PWA service worker
  if("serviceWorker" in navigator){
    navigator.serviceWorker.register("sw.js").catch(()=>{});
  }

  // 초기
  showFormIfPinned();
</script>
</body>
</html>
