<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í˜„ì¥ ì¸¡ì • ì‹œìŠ¤í…œ v2</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; padding-bottom: 50px; }
        .card { border-radius: 15px; border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .history-card { border-left: 6px solid #0d6efd; margin-bottom: 12px; }
        .val-badge { background: #e9ecef; color: #495057; padding: 2px 8px; border-radius: 4px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container py-4">
    <div class="card p-4 mb-4">
        <h5 id="formTitle">ğŸ“ ë°ì´í„° ì…ë ¥</h5>
        <form id="measureForm">
            <input type="hidden" id="rowId">
            <div class="row g-2 mb-2">
                <div class="col-6"><input type="text" id="í˜„ì¥" class="form-control" placeholder="í˜„ì¥" required></div>
                <div class="col-6"><input type="text" id="êµ¬ì—­" class="form-control" placeholder="êµ¬ì—­"></div>
            </div>
            <div class="row g-2 mb-2">
                <div class="col-6"><input type="text" id="ë„ë©´ë²ˆí˜¸" class="form-control" placeholder="ë„ë©´ë²ˆí˜¸"></div>
                <div class="col-6"><input type="text" id="í•­ëª©" class="form-control" placeholder="í•­ëª©"></div>
            </div>
            <div class="row g-2 mb-3">
                <div class="col-4"><input type="number" id="x" class="form-control" placeholder="X"></div>
                <div class="col-4"><input type="number" id="y" class="form-control" placeholder="Y"></div>
                <div class="col-4"><input type="number" id="z" class="form-control" placeholder="Z"></div>
            </div>
            <textarea id="ë©”ëª¨" class="form-control mb-3" placeholder="ë©”ëª¨"></textarea>
            <button type="submit" id="submitBtn" class="btn btn-primary w-100 py-3">ì €ì¥í•˜ê¸°</button>
            <button type="button" id="cancelBtn" class="btn btn-secondary w-100 mt-2" style="display:none;" onclick="resetForm()">ìˆ˜ì • ì·¨ì†Œ</button>
        </form>
    </div>

    <h5 class="mb-3">ì¸¡ì • ë‚´ì—­ <button onclick="loadData()" class="btn btn-sm btn-light">ğŸ”„</button></h5>
    <div id="historyList"></div>
</div>

<script>
    const API_URL = 'ìì‹ ì˜_WEB_APP_URL';
    let deviceId = localStorage.getItem('field_id') || 'DEV-' + Math.random().toString(36).substr(2, 5).toUpperCase();
    localStorage.setItem('field_id', deviceId);

    let fetchedData = [];

    async function loadData() {
        const container = document.getElementById('historyList');
        container.innerHTML = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
        try {
            const res = await fetch(API_URL);
            fetchedData = await res.json();
            container.innerHTML = "";
            
            fetchedData.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'card p-3 history-card';
                // ì‹œíŠ¸ í—¤ë”ê°€ 'x' ì´ë“  'x(mm)' ì´ë“  ì°¾ì•„ì˜¬ ìˆ˜ ìˆë„ë¡ ë³´ì •
                const vx = item['x'] || item['x(mm)'] || 0;
                const vy = item['y'] || item['y(mm)'] || 0;
                const vz = item['z'] || item['z(mm)'] || 0;

                div.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${item['í•­ëª©'] || 'í•­ëª©ì—†ìŒ'}</strong> <span class="ms-2 val-badge">${vx} / ${vy} / ${vz}</span><br>
                            <small class="text-muted">${item['í˜„ì¥']} | ${item['êµ¬ì—­']}</small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="editItem(${idx})">ìˆ˜ì •</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteItem(${item.rowId})">ì‚­ì œ</button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        } catch (e) { container.innerHTML = "ì˜¤ë¥˜ ë°œìƒ"; }
    }

    async function deleteItem(rowId) {
        if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', rowId: rowId }) });
        loadData();
    }

    function editItem(idx) {
        const item = fetchedData[idx];
        document.getElementById('rowId').value = item.rowId;
        document.getElementById('í˜„ì¥').value = item['í˜„ì¥'];
        document.getElementById('êµ¬ì—­').value = item['êµ¬ì—­'];
        document.getElementById('ë„ë©´ë²ˆí˜¸').value = item['ë„ë©´ë²ˆí˜¸'];
        document.getElementById('í•­ëª©').value = item['í•­ëª©'];
        document.getElementById('x').value = item['x'] || item['x(mm)'];
        document.getElementById('y').value = item['y'] || item['y(mm)'];
        document.getElementById('z').value = item['z'] || item['z(mm)'];
        document.getElementById('ë©”ëª¨').value = item['ë©”ëª¨'];
        
        document.getElementById('formTitle').innerText = "ğŸ“ ë°ì´í„° ìˆ˜ì • ì¤‘";
        document.getElementById('submitBtn').className = "btn btn-warning w-100 py-3";
        document.getElementById('cancelBtn').style.display = "block";
        window.scrollTo(0,0);
    }

    function resetForm() {
        document.getElementById('measureForm').reset();
        document.getElementById('rowId').value = "";
        document.getElementById('formTitle').innerText = "ğŸ“ ë°ì´í„° ì…ë ¥";
        document.getElementById('submitBtn').className = "btn btn-primary w-100 py-3";
        document.getElementById('cancelBtn').style.display = "none";
    }

    document.getElementById('measureForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            rowId: document.getElementById('rowId').value,
            í˜„ì¥: document.getElementById('í˜„ì¥').value,
            êµ¬ì—­: document.getElementById('êµ¬ì—­').value,
            ë„ë©´ë²ˆí˜¸: document.getElementById('ë„ë©´ë²ˆí˜¸').value,
            í•­ëª©: document.getElementById('í•­ëª©').value,
            x: document.getElementById('x').value,
            y: document.getElementById('y').value,
            z: document.getElementById('z').value,
            ë‹¨ìœ„: 'mm',
            ë©”ëª¨: document.getElementById('ë©”ëª¨').value,
            deviceId: deviceId
        };
        await fetch(API_URL, { method: 'POST', body: JSON.stringify(data) });
        resetForm();
        loadData();
    });

    window.onload = loadData;
</script>
</body>
</html>
